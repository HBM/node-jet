<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: 1_socket/message-socket.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: 1_socket/message-socket.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MessageSocket = void 0;
/* istanbul ignore file */
const net_1 = require("net");
const _1 = require(".");
/**
 * Class Message socket
 */
class MessageSocket extends _1.EventEmitter {
    last = Buffer.alloc(0);
    len = -1;
    socket;
    constructor(port, ip = '') {
        super();
        if (port instanceof net_1.Socket) {
            this.socket = port;
        }
        else {
            this.socket = (0, net_1.connect)(port, ip);
            this.socket.on('connect', () => {
                this.emit('open');
            });
        }
        this.socket.on('data', (buf) => {
            let bigBuf = Buffer.concat([this.last, buf]);
            while (true) {
                // eslint-disable-line no-constant-condition
                if (this.len &lt; 0) {
                    if (bigBuf.length &lt; 4) {
                        this.last = bigBuf;
                        return;
                    }
                    else {
                        this.len = bigBuf.readUInt32BE(0);
                        bigBuf = bigBuf.subarray(4);
                    }
                }
                if (this.len > 0) {
                    if (bigBuf.length &lt; this.len) {
                        this.last = bigBuf;
                        return;
                    }
                    else {
                        this.emit('message', bigBuf.toString(undefined, 0, this.len));
                        bigBuf = bigBuf.subarray(this.len);
                        this.len = -1;
                    }
                }
            }
        });
        this.socket.setNoDelay(true);
        this.socket.setKeepAlive(true);
        this.socket.once('close', () => {
            this.emit('close');
        });
        this.socket.once('error', (e) => {
            this.emit('error', e);
        });
    }
    /**
     * Send.
     */
    send(msg) {
        const utf8Length = Buffer.byteLength(msg, 'utf8');
        const buf = Buffer.alloc(4 + utf8Length);
        buf.writeUInt32BE(utf8Length, 0);
        buf.write(msg, 4);
        process.nextTick(() => {
            this.socket.write(buf);
            this.emit('sent', msg);
        });
    }
    /**
     * Close.
     */
    close() {
        this.socket.end();
    }
    /**
     * addEventListener method needed for MessageSocket to be used in the browser.
     * It is a wrapper for plain EventEmitter events like ms.on('...', callback).
     *
     * npm module 'ws' also comes with this method.
     * See https://github.com/websockets/ws/blob/master/lib/WebSocket.js#L410
     * That way we can use node-jet with via browserify inside the browser.
     */
    addEventListener(method, 
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    listener) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const onMessage = (data) => {
            listener.call(this, new MessageEvent('data', { data: data }));
        };
        const onClose = (code, message) => {
            listener.call(this, new CloseEvent(code, message));
        };
        const onError = (event) => {
            listener.call(this, event);
        };
        const onOpen = () => {
            listener.call(this, new Event('open'));
        };
        if (typeof listener === 'function') {
            let cb;
            switch (method) {
                case 'message':
                    cb = onMessage;
                    break;
                case 'close':
                    cb = onClose;
                    break;
                case 'error':
                    cb = onError;
                    break;
                case 'open':
                    cb = onOpen;
                    break;
                default:
                    cb = listener;
            }
            this.on(method, cb);
        }
    }
}
exports.MessageSocket = MessageSocket;
exports.default = MessageSocket;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="JsonRPC.html">JsonRPC</a></li><li><a href="Logger.html">Logger</a></li><li><a href="MessageSocket.html">MessageSocket</a></li><li><a href="Socket.html">Socket</a></li><li><a href="TCPServer.html">TCPServer</a></li><li><a href="WebsocketServer.html">WebsocketServer</a></li></ul><h3>Global</h3><ul><li><a href="global.html#encode">encode</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Tue Nov 15 2022 16:23:54 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
